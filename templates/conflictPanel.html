<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src {{cspSource}} 'unsafe-inline'; script-src {{cspSource}} 'unsafe-inline';">
    <title>SVNå†²çªæ–‡ä»¶å¤„ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            padding: 20px;
            line-height: 1.6;
        }

        .header {
            border-bottom: 1px solid var(--vscode-panel-border);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header .folder-path {
            color: var(--vscode-descriptionForeground);
            font-size: 13px;
        }

        /* æ‰«æçŠ¶æ€ */
        .scanning-container {
            text-align: center;
            padding: 60px 20px;
        }

        .scanning-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .scanning-text {
            font-size: 16px;
            margin-bottom: 30px;
            color: var(--vscode-foreground);
        }

        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 8px;
            background-color: var(--vscode-progressBar-background);
            border-radius: 4px;
            margin: 0 auto 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--vscode-progressBar-background);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 13px;
            color: var(--vscode-descriptionForeground);
            margin-bottom: 10px;
        }

        .current-file {
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
            font-style: italic;
        }

        .button {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 13px;
            margin: 5px;
        }

        .button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-secondary {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        .button-secondary:hover {
            background-color: var(--vscode-button-secondaryHoverBackground);
        }

        /* å†²çªåˆ—è¡¨ */
        .conflict-list-container {
            margin-top: 20px;
        }

        .conflict-summary {
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .conflict-summary h2 {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .conflict-count {
            font-size: 14px;
            color: var(--vscode-descriptionForeground);
        }

        .conflict-list {
            list-style: none;
        }

        .conflict-item {
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .conflict-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .conflict-file-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--vscode-foreground);
        }

        .conflict-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 10px;
        }

        .conflict-type-text {
            background-color: var(--vscode-notificationsWarningIcon-foreground);
            color: var(--vscode-editor-background);
        }

        .conflict-type-tree {
            background-color: var(--vscode-errorForeground);
            color: var(--vscode-editor-background);
        }

        .conflict-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .conflict-path {
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
            margin-bottom: 10px;
            word-break: break-all;
        }

        /* æ‰¹é‡æ“ä½œ */
        .batch-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--vscode-panel-border);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* å®ŒæˆçŠ¶æ€ */
        .completed-container {
            text-align: center;
            padding: 60px 20px;
        }

        .completed-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .completed-text {
            font-size: 18px;
            margin-bottom: 30px;
            color: var(--vscode-foreground);
        }

        /* è§£å†³ä¸­çŠ¶æ€ */
        .resolving-container {
            padding: 20px;
        }

        .resolving-list {
            list-style: none;
            margin-top: 20px;
        }

        .resolving-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--vscode-input-background);
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .resolving-icon {
            font-size: 20px;
        }

        .resolving-file-name {
            flex: 1;
        }

        /* é”™è¯¯æ¶ˆæ¯ */
        .error-message {
            background-color: var(--vscode-inputValidation-errorBackground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
            color: var(--vscode-errorForeground);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--vscode-descriptionForeground);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- æ‰«æçŠ¶æ€ -->
    <div id="scanningState" style="display: none;">
        <div class="header">
            <h1>SVNå†²çªæ‰«æ</h1>
            <div class="folder-path">{{folderName}}</div>
        </div>
        <div class="scanning-container">
            <div class="scanning-icon">ğŸ”</div>
            <div class="scanning-text">æ­£åœ¨æ‰«ææ–‡ä»¶å¤¹...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="scanProgressFill"></div>
            </div>
            <div class="progress-text" id="scanProgressText">0%</div>
            <div class="current-file" id="currentFile">å‡†å¤‡å¼€å§‹æ‰«æ...</div>
            <button class="button" id="cancelScanButton" onclick="cancelScan()">å–æ¶ˆæ‰«æ</button>
        </div>
    </div>

    <!-- å†²çªåˆ—è¡¨çŠ¶æ€ -->
    <div id="listState" style="display: none;">
        <div class="header">
            <h1>SVNå†²çªæ–‡ä»¶å¤„ç†</h1>
            <div class="folder-path">{{folderName}}</div>
        </div>
        <div class="conflict-summary">
            <h2>ğŸ“‹ å†²çªæ–‡ä»¶åˆ—è¡¨</h2>
            <div class="conflict-count" id="conflictCount">æ‰«æå®Œæˆï¼šå‘ç° <span id="conflictCountNumber">0</span> ä¸ªå†²çªæ–‡ä»¶</div>
        </div>
        <div class="conflict-list-container">
            <ul class="conflict-list" id="conflictList">
                <!-- å†²çªæ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>
        <div class="batch-actions">
            <button class="button" onclick="resolveAll('mine')">å…¨éƒ¨ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬</button>
            <button class="button" onclick="resolveAll('theirs')">å…¨éƒ¨ä½¿ç”¨æœåŠ¡å™¨ç‰ˆæœ¬</button>
            <button class="button button-secondary" onclick="refresh()">é‡æ–°æ‰«æ</button>
        </div>
    </div>

    <!-- è§£å†³ä¸­çŠ¶æ€ -->
    <div id="resolvingState" style="display: none;">
        <div class="header">
            <h1>SVNå†²çªè§£å†³ä¸­...</h1>
            <div class="folder-path">{{folderName}}</div>
        </div>
        <div class="resolving-container">
            <div class="progress-bar">
                <div class="progress-fill" id="resolveProgressFill"></div>
            </div>
            <div class="progress-text" id="resolveProgressText">0%</div>
            <ul class="resolving-list" id="resolvingList">
                <!-- è§£å†³è¿›åº¦åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </ul>
            <button class="button" id="cancelResolveButton" onclick="cancelResolve()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å®ŒæˆçŠ¶æ€ -->
    <div id="completedState" style="display: none;">
        <div class="header">
            <h1>SVNå†²çªå¤„ç†å®Œæˆ</h1>
            <div class="folder-path">{{folderName}}</div>
        </div>
        <div class="completed-container">
            <div class="completed-icon">âœ…</div>
            <div class="completed-text">æœªå‘ç°å†²çªæ–‡ä»¶ï¼Œå·¥ä½œå‰¯æœ¬çŠ¶æ€æ­£å¸¸</div>
            <button class="button" onclick="refresh()">é‡æ–°æ‰«æ</button>
        </div>
    </div>

    <!-- é”™è¯¯æ¶ˆæ¯ -->
    <div id="errorMessage" class="error-message" style="display: none;">
        <strong>é”™è¯¯ï¼š</strong><span id="errorText"></span>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let conflictFiles = [];
        let currentState = 'scanning';

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            // æ ¹æ®åˆå§‹çŠ¶æ€æ˜¾ç¤ºå¯¹åº”ç•Œé¢
            const state = '{{state}}';
            if (state === 'scanning') {
                showScanningState();
            } else if (state === 'list') {
                showListState();
            } else if (state === 'resolving') {
                showResolvingState();
            } else {
                showCompletedState();
            }

            // å¦‚æœæœ‰å†²çªæ–‡ä»¶æ•°æ®ï¼Œæ˜¾ç¤ºåˆ—è¡¨
            try {
                const files = JSON.parse('{{conflictFiles}}' || '[]');
                if (files.length > 0) {
                    conflictFiles = files;
                    renderConflictList();
                }
            } catch (e) {
                console.error('è§£æå†²çªæ–‡ä»¶æ•°æ®å¤±è´¥:', e);
            }
        });

        // ç›‘å¬æ¥è‡ªæ‰©å±•çš„æ¶ˆæ¯
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'scanStarted':
                    showScanningState();
                    break;
                
                case 'scanProgress':
                    updateScanProgress(message.currentFile, message.progress);
                    break;
                
                case 'scanCompleted':
                    conflictFiles = message.conflictFiles || [];
                    showListState();
                    renderConflictList();
                    break;
                
                case 'scanError':
                    showError(message.error);
                    break;
                
                case 'resolveStarted':
                    addResolvingFile(message.filePath);
                    break;
                
                case 'resolveProgress':
                    updateResolveProgress(message.currentFile, message.progress);
                    break;
                
                case 'resolveCompleted':
                    removeResolvingFile(message.filePath);
                    updateConflictCount(message.remainingCount);
                    if (message.remainingCount === 0) {
                        showCompletedState();
                    }
                    break;
                
                case 'resolveAllStarted':
                    showResolvingState();
                    break;
                
                case 'resolveAllCompleted':
                    conflictFiles = [];
                    showCompletedState();
                    break;
                
                case 'resolveError':
                    showError(message.error);
                    break;
            }
        });

        // æ˜¾ç¤ºæ‰«æçŠ¶æ€
        function showScanningState() {
            currentState = 'scanning';
            document.getElementById('scanningState').style.display = 'block';
            document.getElementById('listState').style.display = 'none';
            document.getElementById('resolvingState').style.display = 'none';
            document.getElementById('completedState').style.display = 'none';
            hideError();
        }

        // æ˜¾ç¤ºåˆ—è¡¨çŠ¶æ€
        function showListState() {
            currentState = 'list';
            document.getElementById('scanningState').style.display = 'none';
            document.getElementById('listState').style.display = 'block';
            document.getElementById('resolvingState').style.display = 'none';
            document.getElementById('completedState').style.display = 'none';
            hideError();
        }

        // æ˜¾ç¤ºè§£å†³ä¸­çŠ¶æ€
        function showResolvingState() {
            currentState = 'resolving';
            document.getElementById('scanningState').style.display = 'none';
            document.getElementById('listState').style.display = 'none';
            document.getElementById('resolvingState').style.display = 'block';
            document.getElementById('completedState').style.display = 'none';
            hideError();
        }

        // æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
        function showCompletedState() {
            currentState = 'completed';
            document.getElementById('scanningState').style.display = 'none';
            document.getElementById('listState').style.display = 'none';
            document.getElementById('resolvingState').style.display = 'none';
            document.getElementById('completedState').style.display = 'block';
            hideError();
        }

        // æ›´æ–°æ‰«æè¿›åº¦
        function updateScanProgress(currentFile, progress) {
            document.getElementById('scanProgressFill').style.width = progress + '%';
            document.getElementById('scanProgressText').textContent = progress + '%';
            document.getElementById('currentFile').textContent = 'å½“å‰æ–‡ä»¶: ' + currentFile;
        }

        // æ›´æ–°è§£å†³è¿›åº¦
        function updateResolveProgress(currentFile, progress) {
            document.getElementById('resolveProgressFill').style.width = progress + '%';
            document.getElementById('resolveProgressText').textContent = progress + '%';
        }

        // æ¸²æŸ“å†²çªåˆ—è¡¨
        function renderConflictList() {
            const list = document.getElementById('conflictList');
            list.innerHTML = '';
            
            conflictFiles.forEach((file, index) => {
                const item = document.createElement('li');
                item.className = 'conflict-item';
                
                const conflictTypeText = file.conflictType === 'text' ? 'æ–‡æœ¬å†²çª' : 
                                         file.conflictType === 'tree' ? 'æ ‘å†²çª' : 'å±æ€§å†²çª';
                const conflictTypeClass = file.conflictType === 'text' ? 'conflict-type-text' : 'conflict-type-tree';
                
                item.innerHTML = `
                    <div class="conflict-item-header">
                        <div>
                            <span class="conflict-file-name">${index + 1}ï¸âƒ£ ${getFileName(file.displayName)}</span>
                            <span class="conflict-type ${conflictTypeClass}">âš ï¸ ${conflictTypeText}</span>
                        </div>
                    </div>
                    <div class="conflict-path">${file.displayName}</div>
                    <div class="conflict-actions">
                        ${file.conflictType === 'text' ? `
                            <button class="button" onclick="viewDiff('${file.path}')">æŸ¥çœ‹å¯¹æ¯”</button>
                            <button class="button" onclick="resolveConflict('${file.path}', 'mine')">ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬</button>
                            <button class="button" onclick="resolveConflict('${file.path}', 'theirs')">ä½¿ç”¨æœåŠ¡å™¨ç‰ˆæœ¬</button>
                        ` : `
                            <button class="button" onclick="viewDiff('${file.path}')">æŸ¥çœ‹è¯¦æƒ…</button>
                            <button class="button" onclick="markResolved('${file.path}')">æ ‡è®°å·²è§£å†³</button>
                        `}
                    </div>
                `;
                
                list.appendChild(item);
            });
            
            updateConflictCount(conflictFiles.length);
        }

        // æ›´æ–°å†²çªæ•°é‡
        function updateConflictCount(count) {
            document.getElementById('conflictCountNumber').textContent = count;
            if (count === 0) {
                showCompletedState();
            }
        }

        // è·å–æ–‡ä»¶å
        function getFileName(fullPath) {
            const parts = fullPath.split(/[/\\]/);
            return parts[parts.length - 1];
        }

        // è§£å†³å†²çª
        function resolveConflict(filePath, strategy) {
            vscode.postMessage({
                command: 'resolveConflict',
                filePath: filePath,
                strategy: strategy
            });
        }

        // æ ‡è®°å·²è§£å†³
        function markResolved(filePath) {
            vscode.postMessage({
                command: 'markResolved',
                filePath: filePath
            });
        }

        // æ‰¹é‡è§£å†³
        function resolveAll(strategy) {
            vscode.postMessage({
                command: 'resolveAll',
                strategy: strategy
            });
        }

        // æŸ¥çœ‹å¯¹æ¯”
        function viewDiff(filePath) {
            vscode.postMessage({
                command: 'viewDiff',
                filePath: filePath
            });
        }

        // åˆ·æ–°
        function refresh() {
            vscode.postMessage({
                command: 'refresh'
            });
        }

        // å–æ¶ˆæ‰«æ
        function cancelScan() {
            // å¯ä»¥æ·»åŠ å–æ¶ˆé€»è¾‘
            showListState();
        }

        // å–æ¶ˆè§£å†³
        function cancelResolve() {
            showListState();
        }

        // æ·»åŠ è§£å†³ä¸­çš„æ–‡ä»¶
        function addResolvingFile(filePath) {
            const list = document.getElementById('resolvingList');
            const item = document.createElement('li');
            item.className = 'resolving-item';
            item.id = 'resolving-' + filePath.replace(/[^a-zA-Z0-9]/g, '-');
            item.innerHTML = `
                <span class="resolving-icon">â³</span>
                <span class="resolving-file-name">${getFileName(filePath)}</span>
                <span>è§£å†³ä¸­...</span>
            `;
            list.appendChild(item);
        }

        // ç§»é™¤è§£å†³ä¸­çš„æ–‡ä»¶
        function removeResolvingFile(filePath) {
            const item = document.getElementById('resolving-' + filePath.replace(/[^a-zA-Z0-9]/g, '-'));
            if (item) {
                item.innerHTML = `
                    <span class="resolving-icon">âœ…</span>
                    <span class="resolving-file-name">${getFileName(filePath)}</span>
                    <span>å·²è§£å†³</span>
                `;
                setTimeout(() => {
                    item.remove();
                }, 1000);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }

        // éšè—é”™è¯¯
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>

